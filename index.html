<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jivandhara Fund Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      max-width: 900px;
      margin: auto;
      background: #1e1e2f; /* ‡§ó‡§°‡§¶ background */
      color: #ffffff; /* ‡§™‡§æ‡§Ç‡§¢‡§∞‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
    }

    h2, h1 {
      color: #ffffff;
    }

    input, button, select {
      font-size: 1rem;
      padding: 6px 8px;
      margin: 4px 0;
      background-color: #2c2c2c;
      color: #ffffff;
      border: 1px solid #444;
      border-radius: 4px;
    }

    input::placeholder {
      color: #ccc;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 15px;
      background: #2a2a2a;
      color: #ffffff;
    }

    th, td {
      border: 1px solid #555;
      padding: 6px;
      text-align: center;
    }

    th {
      background-color: #4caf50; /* ‡§π‡§ø‡§∞‡§µ‡§æ heading */
      color: white;
    }

    td[contenteditable] {
      background-color: #3a3a3a;
      color: white;
      cursor: text;
    }

    button {
      cursor: pointer;
    }

    .flex-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .totals {
      font-weight: bold;
      background: #355e35; /* ‡§•‡•ã‡§°‡§æ ‡§µ‡•á‡§ó‡§≥‡§æ ‡§ó‡§°‡§¶ ‡§π‡§ø‡§∞‡§µ‡§æ */
    }

    .small-btn {
      font-size: 0.8rem;
      padding: 2px 6px;
    }

    .section {
      margin-bottom: 40px;
      padding: 10px;
      background: #2c2c2c;
      color: #ffffff;
      box-shadow: 0 0 5px #444;
      border-radius: 4px;
    }

    label {
      display: block;
      margin-top: 8px;
    }

    @media(max-width: 600px) {
      body {
        padding: 5px;
      }

      table, .flex-row {
        font-size: 0.9rem;
      }

      #memberListTable th {
        background: #3c6e91;
      }

      #memberListTable td {
        background: #444;
      }
    }
  </style>
</head>
<body>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


<h1>Jivandhara Fund Manager</h1>
<div style="margin-left:auto;font-weight:700">Application Developed by Vaibhav Enterprises</div>
<section class="section">
  <h2>‡§®‡§µ‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ú‡•ã‡§°‡§æ / Add New Share Holder</h2>
  <div class="flex-row">
    <input type="text" id="memberName" placeholder="Share Holder Name" />
    <input type="text" id="memberContact" placeholder="Contact No" />
    <button onclick="addMember()">+ Add S.H.</button>
    <button onclick="backupAllToCloud()">‚òÅÔ∏è All Backup</button>
<button onclick="restoreFromCloud()">üì• Backup To Load</button>


</div>
</section>

<section class="section">
  <h2>‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ / Select Share Holder</h2>
  <select id="memberSelect" onchange="loadMemberData()">
    <option value="">-- ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ --</option>
  </select>
  <button onclick="deleteMember()" style="background:#e66464; color:white;">Delete ‡§∏‡§¶‡§∏‡•ç‡§Ø</button>
</section>

<section class="section">
  <h2>‡§∏‡§¶‡§∏‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä / Share Holder List</h2>
  <button onclick="showMemberList()">Select share Holder</button>
  <table id="memberListTable" style="margin-top: 10px; display: none;">
    <thead>
      <tr>
        <th>‡§®‡§æ‡§µ</th>
        <th>Total Share Amount (T.S.A)</th>
        <th>Total Loan Balance Amount (T.L.B.A)</th>

      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="downloadMemberListPDF()">üìÑ Download PDF</button>

</section>


<section class="section" id="memberDataSection" style="display:none;">

  
  <table id="shareTable">
<h2 id="shareHeading">Share ‡§ú‡§Æ‡§æ (‚Çπ)</h2>

<div style="text-align: right; margin-bottom: 5px;">
  <button onclick="shareShareData()" style="background: #25D366; color: white; border: none; padding: 4px 10px; border-radius: 4px;">
    üì§ WhatsApp Share ‡§ú‡§Æ‡§æ
  </button>
</div>

    <thead>
      <tr><th>‡§Æ‡§π‡§ø‡§®‡§æ</th><th>‡§ú‡§Æ‡§æ ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th></tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="totals">
        <td>‡§è‡§ï‡•Ç‡§£ ‡§ú‡§Æ‡§æ</td>
        <td id="totalShare">0</td>
      </tr>
    </tfoot>
  </table>
  <button onclick="addShareRow()">+ Add Row</button>
  
<button onclick="removeShareRow()">- Remove Row</button>
<div id="shareRowCount" style="display:inline-block; margin-left:10px; font-weight:bold;">Rows: 0</div>
  
  <h2 id="loanHeading">‡§ï‡§∞‡•ç‡§ú (Loan) (‚Çπ)</h2>
  <table id="loanTable">
<div style="text-align: right; margin-bottom: 5px;">
  <button onclick="shareLoanData()" style="background: #25D366; color: white; border: none; padding: 4px 10px; border-radius: 4px;">
    üì§ WhatsApp ‡§ï‡§∞‡•ç‡§ú ‡§°‡•á‡§ü‡§æ
  </button>
</div>

    <thead>
      <tr><th>‡§Æ‡§π‡§ø‡§®‡§æ</th><th>‡§ï‡§∞‡•ç‡§ú ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th><th>‡§µ‡•ç‡§Ø‡§æ‡§ú (3%)</th><th>‡§Æ‡•Å‡§¶‡•ç‡§¶‡§≤ ‡§≠‡§∞‡§≤‡•á</th><th>‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï</th></tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="totals">
        <td>‡§è‡§ï‡•Ç‡§£</td>
        <td id="totalLoan">0</td>
        <td id="totalInterest">0</td>
        <td id="totalPrincipal">0</td>
        <td id="totalBalance">0</td>
      </tr>
    </tfoot>
  </table>
  <button onclick="addLoanRow()">+ Add Row</button>
 <button onclick="removeLoanRow()">- Remove Row</button>
<div id="loanRowCount" style="display:inline-block; margin-left:10px; font-weight:bold;">Rows: 0</div>

</section>

<section class="section">
  <h2>‡§°‡•á‡§ü‡§æ Export / Import</h2>
  <div class="flex-row">
    <button onclick="exportExcel()">Export Excel</button>
    <input type="file" id="importFile" accept=".xlsx,.xls" />
    <button onclick="importExcel()">Import Excel</button>
  </div>
</section>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
  // Data structure: array of members, each with name, contact, shares[], loans[]
  let members = [];

  // Currently selected member index
  let currentMemberIndex = null;

  // Load members from localStorage
  function loadMembers() {
    const data = localStorage.getItem('jivandharaMembers');
    members = data ? JSON.parse(data) : [];
    populateMemberSelect();
  }

  function saveMembers() {
    localStorage.setItem('jivandharaMembers', JSON.stringify(members));
  }

  function populateMemberSelect() {
    const select = document.getElementById('memberSelect');
    select.innerHTML = '<option value="">-- ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
    members.forEach((m, i) => {
      select.innerHTML += `<option value="${i}">${m.name} (${m.contact})</option>`;
    });
  }

  function addMember() {
    const name = document.getElementById('memberName').value.trim();
    const contact = document.getElementById('memberContact').value.trim();
    if (!name) {
      alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ");
      return;
    }
    if(members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
      alert("‡§π‡•á ‡§®‡§æ‡§µ ‡§Ü‡§ß‡•Ä‡§ö ‡§Ü‡§π‡•á.");
      return;
    }
    const newMember = {
      name,
      contact,
      shares: [],
      loans: []
    };
    members.push(newMember);
    saveMembers();
    populateMemberSelect();
    document.getElementById('memberName').value = '';
    document.getElementById('memberContact').value = '';
    alert("‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§™‡§£‡•á ‡§ú‡•ã‡§°‡§≤‡•á");
  }

  function loadMemberData() {
  const select = document.getElementById('memberSelect');
  const idx = select.value;
  currentMemberIndex = idx === "" ? null : parseInt(idx);

  if(currentMemberIndex === null){
    document.getElementById('memberDataSection').style.display = 'none';
    return;
  }

  document.getElementById('memberDataSection').style.display = 'block';

  const member = members[currentMemberIndex];
  document.getElementById("shareHeading").textContent = `Share ‡§ú‡§Æ‡§æ (‚Çπ) - ${member.name}`;
  document.getElementById("loanHeading").textContent = `‡§ï‡§∞‡•ç‡§ú (Loan) (‚Çπ) - ${member.name}`;

  // Load shares table
  const shareTbody = document.querySelector('#shareTable tbody');
  shareTbody.innerHTML = '';
  member.shares.forEach((row) => {
    shareTbody.appendChild(createShareRow(row.date, row.amount));
  });
  if(member.shares.length === 0) {
    shareTbody.appendChild(createShareRow("", 0));
  }
  updateShareTotal();

  // Load loans table
  const loanTbody = document.querySelector('#loanTable tbody');
  loanTbody.innerHTML = '';
  member.loans.forEach((row) => {
    loanTbody.appendChild(createLoanRow(row.date, row.loanAmount, row.interest, row.principalPaid));
  });
  if(member.loans.length === 0) {
    loanTbody.appendChild(createLoanRow("", 0, 0, 0));
  }
  updateLoanTotals();

  addContentEditableListeners();
}


 function createShareRow(dateValue = "", amount = 0) {
  const tr = document.createElement("tr");

  const tdDate = document.createElement("td");
  const inputDate = document.createElement("input");
  inputDate.type = "month";
  inputDate.value = dateValue;

  const formattedDateDiv = document.createElement("div");
  formattedDateDiv.style.fontSize = "0.8em";
  formattedDateDiv.style.color = "#666";
  formattedDateDiv.textContent = formatMonthYear(dateValue);

  inputDate.onchange = () => {
    formattedDateDiv.textContent = formatMonthYear(inputDate.value);
    saveShareData();
  };

  tdDate.appendChild(inputDate);
  tdDate.appendChild(formattedDateDiv);
  tr.appendChild(tdDate);

  const tdAmount = document.createElement("td");
  tdAmount.contentEditable = "true";
  tdAmount.textContent = amount || "";
  tdAmount.addEventListener("input", () => {
    saveShareData();
    updateShareTotal();
  });
  tr.appendChild(tdAmount);

  return tr;
}


function createLoanRow(dateValue = "", loanAmount = 0, interest = 0, principalPaid = 0) {
  const tr = document.createElement("tr");

  // Date column
  const tdDate = document.createElement("td");
  const inputDate = document.createElement("input");
  inputDate.type = "month";
  inputDate.value = dateValue;

  // ‡§ñ‡§æ‡§≤‡•Ä formatted date ‡§¶‡§æ‡§ñ‡§µ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä div
  const formattedDateDiv = document.createElement("div");
  formattedDateDiv.style.fontSize = "0.8em";
  formattedDateDiv.style.color = "#666";
  formattedDateDiv.textContent = formatMonthYear(dateValue);

  inputDate.onchange = () => {
    formattedDateDiv.textContent = formatMonthYear(inputDate.value);
    saveLoanData();
  };

  tdDate.appendChild(inputDate);
  tdDate.appendChild(formattedDateDiv);
  tr.appendChild(tdDate);

  // Loan Amount column
  const tdLoan = document.createElement("td");
  tdLoan.contentEditable = "true";
  tdLoan.textContent = loanAmount || "";
  tdLoan.addEventListener("input", () => {
    recalcLoanRows();
    saveLoanData();
    updateLoanTotals();
  });
  tr.appendChild(tdLoan);

  // Interest column
  const tdInterest = document.createElement("td");
  tdInterest.textContent = interest.toFixed ? interest.toFixed(2) : "0.00";
  tr.appendChild(tdInterest);

  // Principal Paid column
  const tdPrincipal = document.createElement("td");
  tdPrincipal.contentEditable = "true";
  tdPrincipal.textContent = principalPaid || "";
  tdPrincipal.addEventListener("input", () => {
    recalcLoanRows();
    saveLoanData();
    updateLoanTotals();
  });
  tr.appendChild(tdPrincipal);

  // Balance column
  const tdBalance = document.createElement("td");
  tdBalance.textContent = "0.00";
  tr.appendChild(tdBalance);

  return tr;
}


  // Add a new share row
 function addShareRow() {
  if(currentMemberIndex === null) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ");

  const tbody = document.querySelector('#shareTable tbody');
  if (tbody.rows.length >= 36) {
    alert("‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 36 ‡§Æ‡§π‡§ø‡§®‡•á.");
    return;
  }

  // ‡§Ü‡§ú‡§ö‡§æ ‡§Æ‡§π‡§ø‡§®‡§æ (YYYY-MM format) ‚Äî input type="month" ‡§∏‡§æ‡§†‡•Ä
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const dateValue = `${year}-${month}`; // ‡§â‡§¶‡§æ. "2025-09"

  const newRow = createShareRow(dateValue, 0);
  tbody.appendChild(newRow);
  saveShareData();
  updateShareTotal();
}
  
function removeShareRow() {
  const table = document.getElementById("shareTable").querySelector("tbody");
  if (table.rows.length > 0) {
    table.deleteRow(table.rows.length - 1);
    updateShareRowCount();
    updateShareTotal();
  }
}
  
  // Add a new loan row
  function addLoanRow() {
  if(currentMemberIndex === null) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ");

  const tbody = document.querySelector('#loanTable tbody');

  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const dateValue = `${year}-${month}`; // ‡§â‡§¶‡§æ. "2025-09"

  const newRow = createLoanRow(dateValue, 0, 0, 0);
  tbody.appendChild(newRow);
  saveLoanData();
  updateLoanTotals();
}
    
  function removeLoanRow() {
  const table = document.getElementById("loanTable").querySelector("tbody");
  if (table.rows.length > 0) {
    table.deleteRow(table.rows.length - 1);
    updateLoanRowCount();
    updateLoanTotals();
  }
}
  

   function saveShareData() {
  const tbody = document.querySelector("#shareTable tbody");
  const shares = [];
  for (let row of tbody.rows) {
    const date = row.cells[0].querySelector("input").value;
    const amount = parseFloat(row.cells[1].textContent) || 0;
    shares.push({ date, amount });
  }
  members[currentMemberIndex].shares = shares;
  saveMembers();
}


  function saveLoanData() {
  const tbody = document.querySelector("#loanTable tbody");
  const loans = [];
  for (let row of tbody.rows) {
    const date = row.cells[0].querySelector("input").value;
    const loanAmount = parseFloat(row.cells[1].textContent) || 0;
    const interest = parseFloat(row.cells[2].textContent) || 0;
    const principalPaid = parseFloat(row.cells[3].textContent) || 0;
    loans.push({ date, loanAmount, interest, principalPaid });
  }
  members[currentMemberIndex].loans = loans;
  saveMembers();
}


  function updateShareTotal() {
    const tbody = document.querySelector('#shareTable tbody');
    let total = 0;
    for(let row of tbody.rows){
      total += parseFloat(row.cells[1].textContent) || 0;
    }
    document.getElementById('totalShare').textContent = total.toFixed(2);
  }

  function recalcLoanRows() {
  const tbody = document.querySelector('#loanTable tbody');
  let prevBalance = 0;

  for (let i = 0; i < tbody.rows.length; i++) {
    const row = tbody.rows[i];
    const loanAmount = parseFloat(row.cells[1].textContent) || 0;
    const principalPaid = parseFloat(row.cells[3].textContent) || 0;

    let interest = 0;
    // ‡§™‡§π‡§ø‡§≤‡•ç‡§Ø‡§æ row ‡§∏‡§æ‡§†‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§ú ‡§®‡§∏‡•á‡§≤ ‚Äî ‡§¶‡•Å‡§∏‡§±‡•ç‡§Ø‡§æ row ‡§™‡§æ‡§∏‡•Ç‡§®
    if (i > 0) {
      interest = prevBalance * 0.03;  // ‡§Æ‡§æ‡§ó‡§ö‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï * 3%
    }

    // ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•ç‡§ú ‡§∞‡§ï‡•ç‡§ï‡§Æ + ‡§µ‡•ç‡§Ø‡§æ‡§ú - ‡§Æ‡•Å‡§¶‡•ç‡§¶‡§≤ ‡§¶‡§ø‡§≤‡•á‡§≤‡•Ä
    const balance = prevBalance + loanAmount + interest - principalPaid;

    // ‡§∏‡•á‡§≤ ‡§Ö‡§™‡§°‡•á‡§ü
    row.cells[2].textContent = interest.toFixed(2);  // ‡§µ‡•ç‡§Ø‡§æ‡§ú
    row.cells[4].textContent = balance.toFixed(2);   // ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï
  
    // ‡§™‡•Å‡§¢‡§ö‡•ç‡§Ø‡§æ iteration ‡§∏‡§æ‡§†‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§†‡•á‡§µ‡§æ
    prevBalance = balance;
  }
}



  function updateLoanTotals() {
  const tbody = document.querySelector('#loanTable tbody');
  let totalLoan = 0, totalInterest = 0, totalPrincipal = 0, totalBalance = 0;

  for (let row of tbody.rows) {
    totalLoan += parseFloat(row.cells[1].textContent) || 0;
    totalInterest += parseFloat(row.cells[2].textContent) || 0;
    totalPrincipal += parseFloat(row.cells[3].textContent) || 0;
  }

  // ‚úÖ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï ‡§´‡§ï‡•ç‡§§ ‡§Ö‡§Ç‡§§‡§ø‡§Æ row ‡§Æ‡§ß‡•Ç‡§® ‡§ò‡•ç‡§Ø‡§æ
  const lastRow = tbody.rows[tbody.rows.length - 1];
  if (lastRow) {
    totalBalance = parseFloat(lastRow.cells[4].textContent) || 0;
  }

  document.getElementById('totalLoan').textContent = totalLoan.toFixed(2);
  document.getElementById('totalInterest').textContent = totalInterest.toFixed(2);
  document.getElementById('totalPrincipal').textContent = totalPrincipal.toFixed(2);
  document.getElementById('totalBalance').textContent = totalBalance.toFixed(2);
}


  function addContentEditableListeners() {
    // Just to be safe, add input listeners again for dynamic rows
    document.querySelectorAll('#shareTable tbody td[contenteditable]').forEach(td => {
      td.oninput = () => {
        saveShareData();
        updateShareTotal();
      };
    });

    document.querySelectorAll('#loanTable tbody td[contenteditable]').forEach(td => {
      td.oninput = () => {
        const tr = td.parentElement;
        recalcLoanRow(tr);
        saveLoanData();
        updateLoanTotals();
      };
    });
  }

  function deleteMember() {
    if(currentMemberIndex === null) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ");
    if(confirm(`‡§∏‡§¶‡§∏‡•ç‡§Ø ${members[currentMemberIndex].name} ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡§æ ‡§Ü‡§π‡•á?`)){
      members.splice(currentMemberIndex, 1);
      saveMembers();
      populateMemberSelect();
      currentMemberIndex = null;
      document.getElementById('memberDataSection').style.display = 'none';
    }
  }

  function showMemberList() {
  const table = document.getElementById('memberListTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = ''; // Reset

  members.forEach(member => {
    const totalShare = member.shares.reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
    const totalLoanBalance = member.loans.reduce((sum, l) => {
      const loanAmt = parseFloat(l.loanAmount) || 0;
      const interest = parseFloat(l.interest) || 0;
      const principal = parseFloat(l.principalPaid) || 0;
      const balance = loanAmt + interest - principal;
      return sum + balance;
    }, 0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${member.name}</td>
      <td>‚Çπ ${totalShare.toFixed(2)}</td>
      <td>‚Çπ ${totalLoanBalance.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

  table.style.display = 'table';
}


function formatMonthYear(monthValue) {
  if (!monthValue) return "";
  const [year, month] = monthValue.split("-");
  const date = new Date(year, month - 1);
  return date.toLocaleString('en-US', { month: 'long', year: 'numeric' });  // English ‡§Æ‡§ß‡•Ç‡§® ‡§´‡•â‡§∞‡§Æ‡•Ö‡§ü
}



function downloadMemberListPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const headers = [["‡§®‡§æ‡§µ", "Total Share Amount (T.S.A)", "Total Loan Balance (T.L.B.A)"]];
  const data = members.map(member => {
    const totalShare = member.shares.reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
    const totalLoanBalance = member.loans.reduce((sum, l) => {
      const loanAmt = parseFloat(l.loanAmount) || 0;
      const interest = parseFloat(l.interest) || 0;
      const principal = parseFloat(l.principalPaid) || 0;
      const balance = loanAmt + interest - principal;
      return sum + balance;
    }, 0);
    return [member.name, `‚Çπ ${totalShare.toFixed(2)}`, `‚Çπ ${totalLoanBalance.toFixed(2)}`];
  });

  doc.autoTable({
    head: headers,
    body: data,
    styles: { font: "helvetica", fontSize: 10 },
    headStyles: { fillColor: [63, 81, 181], textColor: 255 },
    margin: { top: 20 }
  });

  doc.save("shareholder_list.pdf");
}





function formatMonth(dateStr) {
  const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  if (!dateStr) return '‡§Æ‡§π‡§ø‡§®‡§æ ‡§®‡§æ‡§π‡•Ä';

  const parts = dateStr.split('-');
  if (parts.length !== 2) return dateStr;

  const year = parts[0];
  const monthIndex = parseInt(parts[1], 10) - 1;
  if (monthIndex < 0 || monthIndex > 11) return dateStr;

  return `${months[monthIndex]}-${year}`;
}

function shareShareData() {
  if (currentMemberIndex === null) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ");

  const member = members[currentMemberIndex];
  let message = `${member.name} (Share) ‡§ú‡§Æ‡§æ ‡§°‡•á‡§ü‡§æ:\n==================\n`;

  member.shares.forEach((row, i) => {
    const month = formatMonth(row.date);  // ‡§ú‡§∞ ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ‡§ï‡§°‡•á date ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§µ‡§æ‡§™‡§∞‡§æ
    const amount = parseFloat(row.amount || 0);
    message += `${i + 1}:| ${month} | ‚Çπ${amount.toFixed(2)}\n`;
  });

  const total = member.shares.reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
  message += `==================\n‡§è‡§ï‡•Ç‡§£ ‡§ú‡§Æ‡§æ: ‚Çπ${total.toFixed(2)}`;

  const encoded = encodeURIComponent(message);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
}





//------------WhatsApp Lone share ---------------//

function formatMonth(dateStr) {
  const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  if (!dateStr) return '‡§Æ‡§π‡§ø‡§®‡§æ ‡§®‡§æ‡§π‡•Ä';

  const parts = dateStr.split('-');
  if (parts.length !== 2) return dateStr;

  const year = parts[0];
  const monthIndex = parseInt(parts[1], 10) - 1;
  if (monthIndex < 0 || monthIndex > 11) return dateStr;

  return `${months[monthIndex]}-${year}`;
}

function shareLoanData() {
  if (currentMemberIndex === null) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ");

  const member = members[currentMemberIndex];
  let totalLoan = 0;
  let totalBalance = 0;

  let message = `${member.name} (‡§â‡§ö‡§≤ ) ‡§°‡•á‡§ü‡§æ:\n==================\n`;

  member.loans.forEach(loan => {
    const month = formatMonth(loan.date);

    const loanAmount = parseFloat(loan.loanAmount || 0);
    const paidAmount = parseFloat(loan.principalPaid || 0);

    if (loanAmount > 0) {
      totalLoan += loanAmount;
      totalBalance += loanAmount;
      message += `${month} ‡§´‡§Ç‡§°‡§æ‡§§‡•Ç‡§® (‡§â‡§ö‡§≤): ‚Çπ${loanAmount.toFixed(2)}\n`;
    }
    if (paidAmount > 0) {
      message += `${month} ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§≠‡§∞‡§≤‡•Ä: ‚Çπ${paidAmount.toFixed(2)}\n`;
    }
  });

  message += "==================\n";
  message += `‡§è‡§ï‡•Ç‡§£ (‡§â‡§ö‡§≤ ‡§¨‡§æ‡§ï‡•Ä): ‚Çπ${totalBalance.toFixed(2)}`;

  const encoded = encodeURIComponent(message);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
}










  // Excel Export
  function exportExcel() {
    if(currentMemberIndex === null) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ");
    const member = members[currentMemberIndex];
    const wb = XLSX.utils.book_new();

    // Share sheet
    const shareData = member.shares.map((row, i) => ({
      ‡§Æ‡§π‡§ø‡§®‡§æ: i + 1,
      ‡§ú‡§Æ‡§æ: row.amount
    }));
    const ws1 = XLSX.utils.json_to_sheet(shareData);
    XLSX.utils.book_append_sheet(wb, ws1, "Share ‡§ú‡§Æ‡§æ");

    // Loan sheet
    const loanData = member.loans.map((row, i) => ({
      ‡§Æ‡§π‡§ø‡§®‡§æ: formatDateToMarathi(row.date), // üîÅ ‡§á‡§•‡•á ‡§¨‡§¶‡§≤
            ‡§ï‡§∞‡•ç‡§ú: row.loanAmount,
      ‡§µ‡•ç‡§Ø‡§æ‡§ú: row.interest,
      ‡§Æ‡•Å‡§¶‡•ç‡§¶‡§≤: row.principalPaid,
      ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï: row.loanAmount + row.interest - row.principalPaid
    }));
    const ws2 = XLSX.utils.json_to_sheet(loanData);
    XLSX.utils.book_append_sheet(wb, ws2, "Loan");

    XLSX.writeFile(wb, `${member.name}_Jivandhara.xlsx`);
  }

  

function backupAllToCloud() {
  if (!members || members.length === 0) return alert("‚ùå ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä‡§§");

  const allData = members.map(member => {
    const totalShare = (member.shares || []).reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
    const totalLoan = (member.loans || []).reduce((sum, l) => {
      return sum + (parseFloat(l.loanAmount || 0) + parseFloat(l.interest || 0) - parseFloat(l.principalPaid || 0));
    }, 0);

    return {
      name: member.name || "",
      contact: member.contact || "",
      totalShare,
      totalLoan,
      shares: member.shares || [],
      loans: member.loans || []
    };
  });

  fetch("https://script.google.com/macros/s/AKfycbwVc5ZWGKZBkifVSLPrb9JSmys2F5tfhsu1CexWMUB1UlJCAmuX95Kk50ZkNb0QbnO4/exec", {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ members: allData }) // ‚úÖ FIX: allData ‡§µ‡§æ‡§™‡§∞‡§≤‡§æ ‡§Ü‡§π‡•á
  })
    .then(res => res.text())
    .then(msg => alert("‚úÖ Backup OK: " + msg))
    .catch(err => alert("‚ùå Backup Failed: " + err));
}







  // Excel Import
  function importExcel() {
    if(currentMemberIndex === null) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ");
    const fileInput = document.getElementById('importFile');
    if(fileInput.files.length === 0){
      alert("‡§ï‡•É‡§™‡§Ø‡§æ Excel ‡§´‡§æ‡§à‡§≤ ‡§®‡§ø‡§µ‡§°‡§æ");
      return;
    }
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type: 'array'});

      // Read Share ‡§ú‡§Æ‡§æ sheet
      const wsShares = wb.Sheets["Share ‡§ú‡§Æ‡§æ"];
      if(wsShares) {
        const sharesJson = XLSX.utils.sheet_to_json(wsShares);
        members[currentMemberIndex].shares = sharesJson.map(r => ({
          amount: parseFloat(r["‡§ú‡§Æ‡§æ"]) || 0
        }));
      }

      // Read Loan sheet
      const wsLoan = wb.Sheets["Loan"];
      if(wsLoan) {
        const loanJson = XLSX.utils.sheet_to_json(wsLoan);
        members[currentMemberIndex].loans = loanJson.map(r => ({
          loanAmount: parseFloat(r["‡§ï‡§∞‡•ç‡§ú"]) || 0,
          interest: parseFloat(r["‡§µ‡•ç‡§Ø‡§æ‡§ú"]) || 0,
          principalPaid: parseFloat(r["‡§Æ‡•Å‡§¶‡•ç‡§¶‡§≤"]) || 0
        }));
      }
      saveMembers();
      loadMemberData();
      alert("Import ‡§™‡•Ç‡§∞‡•ç‡§£");
    };
    reader.readAsArrayBuffer(file);
  }

 function restoreFromCloud() {
  fetch("https://script.google.com/macros/s/AKfycbwVc5ZWGKZBkifVSLPrb9JSmys2F5tfhsu1CexWMUB1UlJCAmuX95Kk50ZkNb0QbnO4/exec", {
    method: "GET",
    mode: "cors"
  })
    .then(res => {
      if (!res.ok) throw new Error("HTTP error " + res.status);
      return res.json();
    })
    .then(data => {
      members = data.map(d => ({
        name: d["Name"],
        contact: d["Contact"],
        totalShare: parseFloat(d["Total Share"] || 0),
        totalLoan: parseFloat(d["Total Loan"] || 0),
        shares: JSON.parse(d["Shares"] || "[]"),
        loans: JSON.parse(d["Loans"] || "[]")
      }));

      saveToLocal();              
      populateMemberSelect();     // ‚úÖ ‡§á‡§•‡•á ‡§¨‡§¶‡§≤ ‡§ù‡§æ‡§≤‡§æ
      alert("‚úÖ Restore Complete");
    })
    .catch(err => alert("‚ùå Restore Error: " + err));
}









  // Initialization
  loadMembers();

function loadFromLocal() {
  const data = localStorage.getItem('jivandharaMembers');
  members = data ? JSON.parse(data) : [];
  populateMemberSelect();
}

function saveToLocal() {
  localStorage.setItem('jivandharaMembers', JSON.stringify(members));
}



// ‚úÖ ‡§π‡•á ‡§∂‡•á‡§µ‡§ü‡•Ä ‡§ü‡§æ‡§ï‡§æ
window.onload = () => {
  loadFromLocal();
  restoreFromCloud();
updateShareTotal();
recalcLoanRows();
updateLoanTotals();
};


</script>

</body>
</html>

